<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reset your password</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 420px; margin: 6rem auto; padding: 0 1rem; }
        h1 { font-size: 1.4rem; }
        .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 1.25rem; }
        input, button { width: 100%; padding: .8rem; margin-top: .6rem; border-radius: 10px; border: 1px solid #e5e7eb; }
        button { border: none; background: #1f6feb; color: white; cursor: pointer; }
        .hint { color: #6b7280; font-size: .9rem; margin-top: .25rem; }
        .msg  { margin-top: .75rem; font-size: .95rem; }
        .success { color: #065f46; }
        .error { color: #991b1b; }
    </style>
</head>
<body>
<h1>Set a new password</h1>
<div class="card">
    <p class="hint">Enter your new password below.</p>
    <input id="password" type="password" placeholder="New password" autocomplete="new-password" />
    <input id="confirm" type="password" placeholder="Confirm new password" autocomplete="new-password" />
    <button id="save">Save password</button>
    <div id="msg" class="msg"></div>
</div>

<script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(
      "https://fqwyneqoxeoyxnuotvfb.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZxd3luZXFveGVveXhudW90dmZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczMjk3NDEsImV4cCI6MjA3MjkwNTc0MX0.nGcg_yGachZ4_ytwBhGCjonqVU6JxgzVHr2E6QGy_hM"
    );

    const el = (id) => document.getElementById(id);
    const msg = (text, ok = false) => {
      const box = el("msg");
      box.textContent = text;
      box.className = "msg " + (ok ? "success" : "error");
    };

    // Restore session using tokens from hash
    window.addEventListener("DOMContentLoaded", async () => {
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const accessToken = hashParams.get("access_token");
      const refreshToken = hashParams.get("refresh_token");

      if (accessToken && refreshToken) {
        const { error } = await supabase.auth.setSession({
          access_token: accessToken,
          refresh_token: refreshToken,
        });
        if (error) {
          console.error("Session error:", error.message);
          msg("Could not restore session. Please request a new reset link.");
        } else {
          console.log("✅ Session restored");
        }
      } else {
        msg("Invalid or expired reset link. Please request a new one.");
      }
    });

    // Update password
    el("save").addEventListener("click", async () => {
      const p1 = el("password").value.trim();
      const p2 = el("confirm").value.trim();

      if (!p1 || p1.length < 8) return msg("Password must be at least 8 characters.");
      if (p1 !== p2) return msg("Passwords do not match.");

      const { error } = await supabase.auth.updateUser({ password: p1 });
      if (error) {
        msg(error.message || "Could not update password.");
      } else {
        msg("✅ Password updated. You can now return to the app and sign in.", true);
      }
    });
</script>
</body>
</html>
